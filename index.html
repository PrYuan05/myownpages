<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>坦派斯特建國・期中考特訓版 (V14 最終定案)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;700;900&display=swap" rel="stylesheet">

    <!-- MathJax -->
    <script>
    MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']], displayMath: [['$$', '$$']] },
      svg: { fontCache: 'global' }
    };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <style>
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            background-color: #e0f2fe; 
            background-image: radial-gradient(#bae6fd 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f0f9ff; }
        ::-webkit-scrollbar-thumb { background: #38bdf8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #0ea5e9; }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.1);
        }
        
        .note-card { transition: all 0.2s ease; }
        .note-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }

        .draggable-item { cursor: grab; user-select: none; }
        .draggable-item:active { cursor: grabbing; }
        .drop-zone { transition: all 0.3s; }
        .drop-zone.drag-over { background-color: #d1fae5; border-color: #10b981; transform: scale(1.02); }

        mjx-container[jax="CHTML"][display="true"] { margin: 0.2em 0 !important; display: inline-block !important; }
        
        /* Highlighting */
        .highlight { background: linear-gradient(120deg, rgba(255,255,255,0) 0%, rgba(254, 240, 138, 0.6) 100%); padding: 0 4px; font-weight: bold; color: #b45309; }
        .keyword { color: #0369a1; font-weight: bold; }
        .heart-text { color: #e11d48; font-weight: bold; }
        .blue-text { color: #2563eb; font-weight: bold; }
        
        /* Tags */
        .tag-author { background-color: #e0e7ff; color: #4338ca; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-right: 6px; font-weight: bold; }
        .tag-note { background-color: #dcfce7; color: #15803d; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-right: 6px; font-weight: bold; }
        .tag-analysis { background-color: #ffedd5; color: #c2410c; padding: 2px 6px; border-radius: 4px; font-size: 0.8em; margin-right: 6px; font-weight: bold; }
        
        /* Animation */
        @keyframes popIn {
            0% { transform: scale(0.8) translateY(20px); opacity: 0; }
            60% { transform: scale(1.05) translateY(-10px); opacity: 1; }
            100% { transform: scale(1) translateY(0); }
        }
        .victory-anim { animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        
        .victory-img {
            filter: drop-shadow(0 10px 20px rgba(0,0,0,0.15));
            transition: transform 0.3s;
        }
        .victory-img:hover { transform: scale(1.1) rotate(5deg); }
    </style>
</head>
<body class="text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Top Bar -->
    <header class="bg-white/90 backdrop-blur-md border-b border-sky-200 z-20 flex-none shadow-sm h-16">
        <div class="max-w-7xl mx-auto px-4 h-full flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-10 h-10 rounded-full bg-sky-400 flex items-center justify-center text-white text-xl font-bold shadow-lg shadow-sky-200 animate-pulse">
                    <i class="fa-solid fa-face-smile"></i>
                </div>
                <div>
                    <h1 class="text-lg font-black text-slate-700 tracking-tight">坦派斯特・建國衝刺班</h1>
                    <p class="text-xs text-sky-600 font-bold">V14 最終定案版</p>
                </div>
            </div>
            
            <div class="flex items-center gap-2 md:gap-4 bg-slate-100/80 px-4 py-2 rounded-full border border-slate-200 shadow-inner overflow-x-auto">
                <div class="flex items-center gap-2 shrink-0" title="魔素">
                    <i class="fa-solid fa-bolt text-yellow-500"></i>
                    <span id="res-magic" class="font-mono font-bold text-slate-700">0</span>
                </div>
                <div class="w-px h-4 bg-slate-300 shrink-0"></div>
                <div class="flex items-center gap-2 shrink-0" title="草藥">
                    <i class="fa-solid fa-leaf text-green-500"></i>
                    <span id="res-herb" class="font-mono font-bold text-slate-700">0</span>
                </div>
                <div class="w-px h-4 bg-slate-300 shrink-0"></div>
                <div class="flex items-center gap-2 shrink-0" title="等級">
                    <i class="fa-solid fa-chess-rook text-sky-600"></i>
                    <span id="res-level" class="font-bold text-slate-700">Lv.1 村莊</span>
                </div>
            </div>

            <div class="flex gap-2">
                <button onclick="shareApp()" class="hidden md:flex bg-slate-200 text-slate-600 px-4 py-2 rounded-full text-sm font-bold hover:bg-slate-300 transition">
                    <i class="fa-solid fa-share-nodes mr-2"></i> 分享
                </button>
                <button onclick="openQuizSelector()" class="hidden md:flex bg-gradient-to-r from-sky-500 to-blue-600 text-white px-5 py-2 rounded-full text-sm font-bold shadow-lg shadow-sky-200 hover:scale-105 transition">
                    <i class="fa-solid fa-dungeon mr-2"></i> 討伐任務
                </button>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <div class="flex flex-1 overflow-hidden">
        
        <!-- Sidebar -->
        <nav class="w-64 bg-white/80 border-r border-sky-100 flex-none hidden md:flex flex-col backdrop-blur">
            <div class="p-4 space-y-1 overflow-y-auto flex-1 custom-scrollbar">
                <div class="mb-6 px-2 text-center">
                    <div class="w-full h-32 bg-sky-100 rounded-xl mb-2 flex items-center justify-center text-sky-300 text-6xl shadow-inner">
                        <i class="fa-solid fa-dragon"></i>
                    </div>
                    <div class="text-xs text-slate-400 font-bold">"利姆路大人說：<br>選項是隨機的，要看清楚喔！"</div>
                </div>

                <p class="px-3 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">管理與建設</p>
                <button onclick="switchView('city')" id="nav-city" class="nav-item w-full text-left p-3 rounded-xl flex items-center gap-3 bg-sky-50 text-sky-700 font-bold border border-sky-100 mb-2 transition-all">
                    <i class="fa-solid fa-city w-6 text-center"></i> 城邦概況 City
                </button>

                <p class="px-3 text-xs font-bold text-slate-400 uppercase tracking-wider mb-2 mt-4">學科修煉</p>
                <div id="sidebar-subjects" class="space-y-1"></div>
            </div>
        </nav>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto relative scroll-smooth p-4 md:p-8" id="main-container">
            <!-- Dynamic Content -->
        </main>
    </div>

    <!-- Quiz Modal -->
    <div id="quiz-modal" class="fixed inset-0 z-50 hidden transition-opacity duration-300" aria-labelledby="modal-title" role="dialog" aria-modal="true">
        <div class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeQuizModal()"></div>
        <div class="fixed inset-0 z-10 overflow-y-auto pointer-events-none">
            <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
                <div class="pointer-events-auto relative transform overflow-hidden rounded-3xl bg-white text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-3xl border-4 border-sky-200 flex flex-col max-h-[90vh]">
                    
                    <div class="bg-gradient-to-r from-sky-500 to-blue-600 px-6 py-4 flex justify-between items-center shrink-0">
                        <h3 class="text-lg font-bold text-white flex items-center gap-2">
                            <i class="fa-solid fa-khanda"></i>
                            <span id="quiz-modal-title">魔物討伐戰</span>
                        </h3>
                        <div class="flex items-center gap-3">
                            <div class="bg-black/20 px-3 py-1 rounded-full text-white text-xs font-mono">
                                <i class="fa-solid fa-heart text-red-400 mr-1"></i>HP: <span id="quiz-hp">3</span>
                            </div>
                            <button onclick="closeQuizModal()" class="text-white/80 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
                        </div>
                    </div>

                    <div class="px-6 py-6 overflow-y-auto custom-scrollbar flex-1 bg-sky-50/30">
                        <!-- Selector -->
                        <div id="quiz-selector" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
                        
                        <!-- Question -->
                        <div id="quiz-question-view" class="hidden max-w-2xl mx-auto w-full">
                            <div class="w-full bg-slate-200 rounded-full h-3 mb-6 overflow-hidden border border-slate-300">
                                <div id="quiz-progress-bar" class="bg-gradient-to-r from-green-400 to-emerald-500 h-3 rounded-full transition-all duration-500" style="width: 0%"></div>
                            </div>
                            <div id="question-card" class="bg-white p-6 rounded-2xl shadow-lg border border-sky-100 min-h-[300px] flex flex-col justify-center"></div>
                        </div>

                        <!-- Results (Integrated Layout to fix popup issues) -->
                        <div id="quiz-results-view" class="hidden flex-col items-center justify-center py-8 victory-anim">
                            <div class="relative w-48 h-48 mx-auto mb-6">
                                <!-- User's Custom Image Slot -->
                                <img src="rimuru_victory.png" 
                                     onerror="this.src='https://cdn-icons-png.flaticon.com/512/4712/4712009.png'"
                                     class="w-full h-full object-contain victory-img" alt="Victory">
                            </div>
                            
                            <h2 class="text-4xl font-black text-slate-800 mb-2 drop-shadow-sm">討伐大成功！</h2>
                            <p id="result-msg" class="text-slate-500 mb-8 font-bold">戰利品已送達城邦倉庫</p>
                            
                            <div class="flex justify-center gap-6 mb-8">
                                <div class="bg-white p-4 rounded-2xl shadow-md border-2 border-yellow-100 w-32 flex flex-col items-center">
                                    <div class="text-xs text-slate-400 font-bold uppercase mb-1">魔素</div>
                                    <div id="reward-magic" class="text-3xl font-black text-yellow-500">+0</div>
                                </div>
                                <div class="bg-white p-4 rounded-2xl shadow-md border-2 border-green-100 w-32 flex flex-col items-center">
                                    <div class="text-xs text-slate-400 font-bold uppercase mb-1">草藥</div>
                                    <div id="reward-herb" class="text-3xl font-black text-green-500">+0</div>
                                </div>
                            </div>

                            <button onclick="closeQuizModal()" class="bg-gradient-to-r from-sky-500 to-blue-600 text-white px-10 py-3 rounded-xl font-bold hover:shadow-lg hover:scale-105 transition transform">
                                返回城邦
                            </button>
                        </div>
                    </div>

                    <div id="quiz-footer" class="bg-white px-6 py-4 border-t border-slate-100 flex justify-between items-center shrink-0 hidden">
                        <button onclick="useHerb()" id="btn-use-herb" class="text-green-600 font-bold text-sm hover:bg-green-50 px-3 py-1 rounded transition flex items-center gap-1">
                            <i class="fa-solid fa-leaf"></i> 使用草藥提示 (-1)
                        </button>
                        <button id="btn-next" onclick="nextQuestion()" class="bg-sky-600 text-white px-6 py-2 rounded-lg font-bold text-sm hover:bg-sky-500 transition shadow-md opacity-50 cursor-not-allowed" disabled>
                            下一題 Next <i class="fa-solid fa-arrow-right ml-1"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- GAME STATE ---
        const gameState = {
            magicules: 1700,
            herbs: 5,
            level: 1,
            buildings: { 'village': true, 'blacksmith': false, 'school': false, 'arena': false, 'castle': false }
        };

        const buildingsInfo = {
            'village': { name: "哥布林村", cost: 0, icon: "campground", desc: "冒險的起點" },
            'blacksmith': { name: "凱金鐵匠鋪", cost: 500, icon: "hammer", desc: "解鎖數學與物理工具" },
            'school': { name: "自由學園", cost: 1200, icon: "school", desc: "提升知識獲取速度" },
            'arena': { name: "武鬥大會", cost: 2500, icon: "trophy", desc: "挑戰高難度測驗" },
            'castle': { name: "魔王城", cost: 5000, icon: "crown", desc: "統治鳩拉大森林" }
        };

        // --- CONTENT DATA (V11 - Expanded Notes) ---
        const studyData = {
            chinese: { id: 'chinese', title: "國文 Chinese", icon: "pen-nib", color: "violet", summary: "重點：生平、註釋、解析" },
            english: { id: 'english', title: "英文 English", icon: "language", color: "blue", summary: "重點：單字字彙、文法" },
            math: { id: 'math', title: "數學 Mathematics", icon: "calculator", color: "indigo", summary: "範圍：2-1~2-4" },
            biology: { id: 'biology', title: "生物 Biology", icon: "dna", color: "emerald", summary: "範圍：3-2~p134 (循環、運輸)" },
            geography: { id: 'geography', title: "地理 Geography", icon: "earth-asia", color: "sky", summary: "範圍：p31-45 (地形、海岸)" },
            history: { id: 'history', title: "歷史 History", icon: "landmark", color: "amber", summary: "範圍：p27-42 (大航海)" },
            civics: { id: 'civics', title: "公民 Civics", icon: "scale-balanced", color: "rose", summary: "範圍：家庭生活、親屬關係" }
        };

        const notesData = {
            chinese: [
                { 
                    title: "L4 論語選 - 孔子 (Confucius)", 
                    details: [
                        "<span class='tag-author'>作者</span><strong>孔子</strong>：名丘，字仲尼，春秋魯國人。至聖先師，儒家代表，首創私人講學。",
                        "<span class='tag-note'>註釋</span><strong>時習</strong>：時常溫習。 <strong>慍</strong>(ㄩㄣˋ)：生氣、怨恨。 <strong>信</strong>：誠信。 <strong>亦</strong>：也。",
                        "<span class='tag-analysis'>解析</span>1.「學而時習之，不亦說乎」：強調實踐的快樂 (悅)。",
                        "<span class='tag-analysis'>解析</span>2.「有朋自遠方來」：強調以文會友、志同道合的樂趣。",
                        "<span class='tag-analysis'>解析</span>3.「三人行必有我師」：強調隨時隨地向人學習 (擇善而從)。"
                    ]
                },
                { 
                    title: "L5 背影 - 朱自清", 
                    details: [
                        "<span class='tag-author'>作者</span><strong>朱自清</strong>：現代散文家、詩人。風格細膩真摯。",
                        "<span class='tag-note'>註釋</span><strong>躊躇</strong>(ㄔㄡˊ ㄔㄨˊ)：猶豫不決。 <strong>蹣跚</strong>(ㄆㄢˊ ㄕㄢ)：走路緩慢不穩。 <strong>頹唐</strong>：衰老敗落。",
                        "<span class='tag-analysis'>解析</span><strong>關鍵意象</strong>：<strong>紫毛大衣/朱紅橘子</strong> (色彩對比，象徵父愛溫暖)。",
                        "<span class='tag-analysis'>解析</span><strong>動作描寫</strong>：攀、縮、傾 (描繪父親爬月台的艱辛，情感高潮)。",
                        "<span class='tag-analysis'>解析</span><strong>結構</strong>：開頭點題(不忘背影) &rarr; 買橘子(高潮/惜別背影) &rarr; 讀信結尾(再現背影)。"
                    ]
                },
                { 
                    title: "L6 心囚 - 杏林子", 
                    details: [
                        "<span class='tag-author'>作者</span><strong>杏林子</strong>：本名劉俠，罹患類風濕性關節炎，創辦伊甸基金會。",
                        "<span class='tag-note'>註釋</span><strong>禁錮</strong>：監禁。 <strong>名韁利鎖</strong>：被名利束縛。",
                        "<span class='tag-analysis'>解析</span><strong>主旨</strong>：真正的囚禁是內心的枷鎖（成見、慾望）。心靈的自由取決於轉念。"
                    ]
                }
            ],
            english: [
                {
                    title: "1. 單字字彙統整 (Vocabulary)",
                    details: [
                        "<strong>節慶 (Festivals)</strong>：Christmas (聖誕), New Year (新年), Holiday (假期), Celebrate (慶祝)。",
                        "<strong>序數 (Ordinals)</strong>：First (1st), Second (2nd), Third (3rd), Twelfth (12th, 去ve加fth)。",
                        "<strong>動作 (Actions)</strong>：Clap (拍手), Wave (揮手), Touch (碰), Stand (站), Shout (大叫)。",
                        "<strong>其他</strong>：Date (日期), Month (月), Together (一起), Ready (準備好的)。"
                    ]
                },
                {
                    title: "2. 名詞複數變化 (Plurals)",
                    details: [
                        "1. 一般：+s (map&rarr;maps)。",
                        "2. s, x, ch, sh：+es (bus&rarr;buses, watch&rarr;watches)。",
                        "3. 子音+y：去y+ies (city&rarr;cities)。(母音+y直接+s: boys)。",
                        "4. f, fe：去f+ves (leaf&rarr;leaves, wife&rarr;wives)。",
                        "5. 不規則：man&rarr;men, child&rarr;children, mouse&rarr;mice, fish&rarr;fish。"
                    ]
                },
                {
                    title: "3. 現在進行式 (V-ing)",
                    details: [
                        "<strong>句型</strong>：S + Be (am/is/are) + V-ing。",
                        "<strong>規則</strong>：一般+ing；去e+ing (dance&rarr;dancing)；重複字尾+ing (run&rarr;running, swim&rarr;swimming)。"
                    ]
                }
            ],
            biology: [
                { 
                    title: "1. 植物的運輸 (Plant Transport)", 
                    details: [
                        "<strong>維管束</strong>：<span class='text-emerald-600 font-bold'>內木外韌</span>。形成層向內生木質部，向外生韌皮部。",
                        "<strong>木質部</strong>：死細胞，運輸<span class='highlight'>水分/礦物質</span>，單向向上 (蒸散作用)。",
                        "<strong>韌皮部</strong>：活細胞，運輸<span class='highlight'>養分 (糖)</span>，雙向運輸。",
                        "<strong>排列</strong>：雙子葉(環狀/有形成層/年輪)，單子葉(散生/無)。"
                    ]
                },
                { 
                    title: "2. 循環系統 - 心臟 (Heart)", 
                    details: [
                        "<strong>構造</strong>：上房下室。左心室壁最厚(打全身)。",
                        "<strong>血液性質</strong>：<span class='heart-text'>左半邊 (左心房/室)</span> = 充氧血；<span class='blue-text'>右半邊 (右心房/室)</span> = 缺氧血。",
                        "<strong>連接血管</strong>：左心室-主動脈；右心室-肺動脈；左心房-肺靜脈；右心房-大靜脈。",
                        "<strong>瓣膜</strong>：位於心房心室間、心室動脈間，防止血液逆流。"
                    ]
                },
                { 
                    title: "3. 血管與循環路徑", 
                    details: [
                        "<strong>血管</strong>：動脈(壁厚/快)、靜脈(有瓣膜)、微血管(壁薄/交換)。",
                        "<strong>體循環</strong>：左心室&rarr;主動脈&rarr;全身微血管&rarr;大靜脈&rarr;右心房。",
                        "<strong>肺循環</strong>：右心室&rarr;肺動脈(缺氧)&rarr;<span class='highlight'>肺泡微血管(換氣)</span>&rarr;肺靜脈(充氧)&rarr;左心房。"
                    ]
                }
            ],
            math: [
                { 
                    title: "2-1 ~ 2-2 質因數與公因倍數", 
                    details: [
                        "<strong>質數</strong>：只有1和本身兩個因數 (2, 3, 5, 7, 11...)。",
                        "<strong>標準分解式</strong>：\\( 12 = 2^2 \\times 3 \\)。",
                        "<strong>GCD (最大公因數)</strong>：取共同質因數的<span class='highlight'>最小</span>次方。",
                        "<strong>LCM (最小公倍數)</strong>：取所有質因數的<span class='highlight'>最大</span>次方。"
                    ]
                },
                {
                    title: "2-3 ~ 2-4 分數運算",
                    details: [
                        "<strong>加減</strong>：先通分。 <strong>乘法</strong>：分子乘分子，分母乘分母。",
                        "<strong>除法</strong>：乘以倒數。\\( \\frac{a}{b} \\div \\frac{c}{d} = \\frac{a}{b} \\times \\frac{d}{c} \\)。",
                        "<strong>負分數</strong>：奇數個負號為負，偶數個負號為正。"
                    ]
                }
            ],
            geography: [
                { 
                    title: "1. 臺灣的地形特色 (Landforms)", 
                    details: [
                        "<strong>五大地形</strong>：山地(面積最大/約佔2/3)、丘陵、台地、盆地、平原。",
                        "<strong>中央山脈</strong>：縱貫南北，為分水嶺，導致河川東西分流。",
                        "<strong>平原</strong>：多由河川沖積而成，西部主要為平原（嘉南平原最大）。",
                        "<strong>盆地</strong>：臺北盆地（昔為臺北湖，淤積而成）、臺中盆地、埔里盆地。",
                        "<strong>關鍵經緯</strong>：北回歸線 (23.5°N) 通過嘉義水上與花蓮豐濱，區分熱帶與副熱帶氣候。"
                    ]
                },
                { 
                    title: "2. 海岸類型的比較", 
                    details: [
                        "<strong>北部 (岬灣海岸)</strong>：岩層軟硬相間，海岸曲折，多天然良港 (如基隆港)。",
                        "<strong>西部 (沙岸)</strong>：河川堆積盛，海岸平直，多沙灘、沙洲、潟湖。優點：適合養殖漁業、鹽田。缺點：港口少。",
                        "<strong>南部 (珊瑚礁海岸)</strong>：恆春半島，熱帶氣候，裙礁地形。",
                        "<strong>東部 (斷層海岸)</strong>：板塊擠壓，斷層逼近海岸，海岸陡峭平直，水深，少腹地。"
                    ]
                },
                { 
                    title: "3. 天氣與水文特徵", 
                    details: [
                        "<strong>季風氣候</strong>：夏季吹西南季風 (南部多雨)；冬季吹東北季風 (北部/東北部多雨，因地形雨)。",
                        "<strong>特殊天氣</strong>：梅雨 (5-6月滯留鋒)、颱風 (夏秋之際)、寒害 (冬季強烈大陸冷氣團)。",
                        "<strong>河川特性</strong>：<span class='highlight'>坡陡流急</span> (山高水急)、含沙量大 (地質鬆軟)、流量變化大 (荒溪型河川)。",
                        "<strong>主要河川</strong>：濁水溪 (全臺最長)、高屏溪 (流域面積最大)、淡水河 (流量最穩，因基隆河與大漢溪匯流)。"
                    ]
                }
            ],
            history: [
                { 
                    title: "1. 大航海時代 (Age of Discovery)", 
                    details: [
                        "<strong>背景</strong>：16-17世紀，歐洲國家尋找東方香料航路。",
                        "<strong>荷蘭 (南部)</strong>：1624年建<span class='keyword'>熱蘭遮城</span>(大員/行政)、<span class='keyword'>普羅民遮城</span>(赤崁)。轉運貿易(絲/銀/香料)，出口鹿皮、蔗糖。引進黃牛。",
                        "<strong>西班牙 (北部)</strong>：1626年建<span class='keyword'>聖薩爾瓦多城</span>(基隆)、<span class='keyword'>聖多明哥城</span>(淡水)。主要傳播<strong>天主教</strong>，開採硫磺。1642年被荷蘭趕走。",
                        "<strong>郭懷一事件 (1652)</strong>：漢人反抗荷蘭人重稅，荷人聯合原住民鎮壓。"
                    ]
                },
                { 
                    title: "2. 原住民與外來者", 
                    details: [
                        "<strong>傳教與教育</strong>：荷蘭人創立新港文(羅馬拼音)傳教、設學校。",
                        "<strong>經濟活動</strong>：贌社制度(漢人承包與原住民交易)，導致經濟剝削。",
                        "<strong>史前文化</strong>：長濱(舊/火)、大坌坑(新/繩紋陶)、十三行(鐵器)。"
                    ]
                }],
            civics: [
                { 
                    title: "1. 社會規範 (Social Norms)", 
                    details: [
                        "<strong>風俗習慣</strong>：長期累積的生活慣例 (如過年圍爐、中元普渡)。約束力：社會輿論。",
                        "<strong>倫理道德</strong>：評斷是非善惡的標準 (如讓座、孝順、誠實)。約束力：良心譴責。",
                        "<strong>宗教信仰</strong>：對超自然力量的崇拜 (如不吃豬肉、受戒)。約束力：教規/因果報應。",
                        "<strong>法律</strong>：由國家制定。特徵：<span class='highlight'>具有國家強制力</span>。違反受刑罰或行政罰 (最嚴厲的處罰)。"
                    ]
                },
                { 
                    title: "2. 團體的分類 (Social Groups)", 
                    details: [
                        "<strong>血緣團體</strong>：基於血緣或婚姻關係。例：家庭、宗親會。",
                        "<strong>地緣團體</strong>：基於居住地域關係。例：社區管委會、同鄉會、鄰里。",
                        "<strong>業緣團體</strong>：基於工作職業關係。例：工會、醫師公會、商業同業公會。",
                        "<strong>趣緣團體</strong>：基於共同興趣或理想。例：登山社、動漫研究社、讀書會、慈濟功德會。"
                    ]
                },
                { 
                    title: "3. 親屬關係 (Kinship)", 
                    details: [
                        "<strong>配偶</strong>：因婚姻而產生的關係 (無親等之分)。",
                        "<strong>血親</strong>：<br>- 自然血親：有血緣關係 (父母、子女、兄弟)。<br>- 法定血親：經<span class='highlight'>收養</span>程序 (養父母、養子女)。",
                        "<strong>姻親</strong>：<br>- 血親的配偶 (如：嫂嫂、姊夫)。<br>- 配偶的血親 (如：岳父、公婆)。<br>- 配偶的血親的配偶 (如：妯娌、連襟)。"
                    ]
                },
                { 
                    title: "4. 親等計算 (Degrees)", 
                    details: [
                        "<strong>直系</strong>：算代數。父母(1親等)、祖父母(2親等)。",
                        "<strong>旁系</strong>：算到共同祖先再加總。兄弟姊妹(2親等)、堂/表兄弟姊妹(4親等)。",
                        "<strong>限制</strong>：民法規定，旁系血親六親等內不得結婚。"
                    ]
                },
                { 
                    title: "5. 家庭型態與平權", 
                    details: [
                        "<strong>家庭型態</strong>：小家庭(核心)、折衷(三代)、大家庭。現代出現頂客族、單親、重組家庭。",
                        "<strong>平權</strong>：子女姓氏約定、家務分工、繼承權平等、防暴法保護成員。"
                    ]
                }
            ]
        };

        // --- EXPANDED QUESTION BANK (V11 - 30+ Qs per subject) ---
        const qDB = {
            math: [
                {q:"\\( 24 \\) 的標準分解式？",a:["\\( 2^3 \\times 3 \\)","\\( 2 \\times 3 \\times 4 \\)","\\( 2^2 \\times 6 \\)","\\( 8 \\times 3 \\)"],c:0,r:"\\( 24 = 2^3 \\times 3 \\)。"},
                {q:"下列何者與 \\( 12 \\) 互質？",a:["9","8","25","21"],c:2,r:"\\( 12=2^2 \\times 3 \\)，\\( 25=5^2 \\)，無公因數。"},
                {q:"求 \\( (18, 30) \\) 的 GCD？",a:["6","3","2","90"],c:0,r:"\\( 2 \\times 3 = 6 \\)。"},
                {q:"\\( [4, 6] \\) 的 LCM？",a:["24","12","2","4"],c:1,r:"12。"},
                {q:"\\( \\frac{1}{3} + \\frac{1}{4} = ? \\)",a:["\\( \\frac{7}{12} \\)","\\( \\frac{2}{7} \\)","\\( \\frac{1}{12} \\)","\\( \\frac{1}{7} \\)"],c:0,r:"\\( \\frac{4}{12} + \\frac{3}{12} = \\frac{7}{12} \\)。"},
                {q:"\\( \\frac{2}{5} \\times \\frac{10}{3} = ? \\)",a:["\\( \\frac{4}{3} \\)","\\( \\frac{3}{4} \\)","\\( \\frac{20}{8} \\)","\\( \\frac{1}{3} \\)"],c:0,r:"\\( \\frac{4}{3} \\)。"},
                {q:"\\( \\frac{3}{4} \\div \\frac{1}{2} = ? \\)",a:["\\( \\frac{3}{2} \\)","\\( \\frac{3}{8} \\)","\\( \\frac{1}{2} \\)","\\( \\frac{1}{4} \\)"],c:0,r:"\\( \\frac{3}{2} \\)。"},
                {q:"下列何者為質數？",a:["27","29","51","57"],c:1,r:"29。"},
                {q:"\\( -\\frac{1}{2} \\times (-\\frac{4}{5}) \\) 的符號？",a:["正","負","0","不一定"],c:0,r:"正。"},
                {q:"計算 \\( 2^3 \\times 3^2 \\) 與 \\( 2^2 \\times 3^3 \\) 的 GCD？",a:["\\( 2^2 \\times 3^2 \\)","\\( 2^3 \\times 3^3 \\)","\\( 2 \\times 3 \\)","\\( 6 \\)"],c:0,r:"取最小次方。"},
                {q:"120 的相異質因數有幾個？",a:["3","4","5","2"],c:0,r:"2, 3, 5。"},
                {q:"\\( \\frac{5}{6} - \\frac{1}{2} = ? \\)",a:["\\( \\frac{1}{3} \\)","\\( \\frac{4}{4} \\)","\\( \\frac{2}{3} \\)","\\( \\frac{1}{6} \\)"],c:0,r:"\\( \\frac{1}{3} \\)。"},
                {q:"若 a, b 互質，則 \\( [a, b] = ? \\)",a:["\\( a \\times b \\)","1","\\( a+b \\)","\\( a-b \\)"],c:0,r:"相乘。"},
                {q:"\\( ( -\\frac{3}{4} )^2 \\) 的值？",a:["\\( \\frac{9}{16} \\)","\\( -\\frac{9}{16} \\)","\\( \\frac{6}{8} \\)","\\( \\frac{9}{4} \\)"],c:0,r:"正。"},
                {q:"求 42, 63 的 GCD？",a:["21","7","3","1"],c:0,r:"21。"},
                {q:"最接近 -3 的整數？",a:["-3","-2","-4","0"],c:0,r:"-3。"},
                {q:"\\( 3 \\div \\frac{1}{3} = ? \\)",a:["9","1","3","0"],c:0,r:"9。"},
                {q:"下列分數何者最大？",a:["\\( \\frac{3}{4} \\)","\\( \\frac{1}{2} \\)","\\( \\frac{1}{3} \\)","\\( \\frac{2}{5} \\)"],c:0,r:"0.75。"},
                {q:"絕對值小於 10 的質數有幾個？",a:["4","5","3","6"],c:0,r:"2,3,5,7。"},
                {q:"\\( -2 \\frac{1}{3} \\) 的倒數？",a:["\\( -\\frac{3}{7} \\)","\\( 2 \\frac{1}{3} \\)","\\( -\\frac{7}{3} \\)","\\( \\frac{3}{7} \\)"],c:0,r:"\\( -\\frac{3}{7} \\)。"},
                {q:"計算 \\( 12 - 2 \\times [ 5 - (-3) ] \\)",a:["-4","4","-16","80"],c:0,r:"\\( 12 - 2 \\times 8 = 12 - 16 = -4 \\)。"},
                {q:"\\( 100 \\) 的因數個數？",a:["9","8","10","7"],c:0,r:"\\( 100=2^2 \\times 5^2 \\), \\( (2+1)(2+1)=9 \\)。"},
                {q:"\\( -2 \\times (-3) \\times (-4) \\)",a:["-24","24","-9","-14"],c:0,r:"奇數個負號為負。"},
                {q:"\\( | -7 | + | 3 | \\)",a:["10","-4","4","-10"],c:0,r:"7+3=10。"},
                {q:"\\( \\frac{3}{5} + \\frac{1}{2} \\)",a:["\\( \\frac{11}{10} \\)","\\( \\frac{4}{7} \\)","\\( \\frac{1}{10} \\)","\\( \\frac{4}{10} \\)"],c:0,r:"\\( \\frac{6}{10}+\\frac{5}{10} \\)。"},
                {q:"\\( (-2)^3 \\) 與 \\( -2^3 \\)",a:["相等","前者大","後者大","互為倒數"],c:0,r:"皆為 -8。"},
                {q:"最小的質數？",a:["2","1","3","0"],c:0,r:"2。"},
                {q:"\\( \\frac{2}{3} \\times \\frac{9}{4} \\)",a:["\\( \\frac{3}{2} \\)","\\( \\frac{2}{3} \\)","\\( \\frac{1}{2} \\)","\\( \\frac{11}{7} \\)"],c:0,r:"約分後得 3/2。"},
                {q:"\\( 1 \\frac{1}{2} \\div \\frac{3}{2} \\)",a:["1","\\( \\frac{9}{4} \\)","2","\\( \\frac{3}{2} \\)"],c:0,r:"\\( \\frac{3}{2} \\times \\frac{2}{3} = 1 \\)。"},
                {q:"下列何者互質？",a:["14, 15","12, 18","9, 21","2, 4"],c:0,r:"GCD(14,15)=1。"}
            ],
            biology: [
                {q:"心臟的哪一個腔室連接「主動脈」？",a:["左心室","左心房","右心房","右心室"],c:0,r:"左心室。"},
                {q:"血液中負責攜帶氧氣的是？",a:["紅血球","白血球","血小板","血漿"],c:0,r:"紅血球。"},
                {q:"肺循環的路徑起點是？",a:["右心室","左心室","左心房","右心房"],c:0,r:"右心室。"},
                {q:"下列哪條血管流的是「充氧血」？",a:["肺靜脈","肺動脈","上大靜脈","下大靜脈"],c:0,r:"肺靜脈。"},
                {q:"物質交換主要在哪裡進行？",a:["微血管","動脈","靜脈","心臟"],c:0,r:"微血管。"},
                {q:"防止血液倒流的構造「瓣膜」，存在於？",a:["以上皆是","動脈與心室間","靜脈內","心房與心室間"],c:0,r:"心臟與靜脈皆有。"},
                {q:"植物體內運輸水分的構造？",a:["木質部","韌皮部","形成層","表皮"],c:0,r:"木質部。"},
                {q:"木質部的運輸方向？",a:["單向向上","單向向下","雙向","不一定"],c:0,r:"單向向上。"},
                {q:"韌皮部的運輸方向？",a:["雙向","由下往上","由上往下","不一定"],c:0,r:"雙向。"},
                {q:"形成層的功能？",a:["細胞分裂","吸收水分","光合作用","保護"],c:0,r:"細胞分裂。"},
                {q:"年輪是哪一部分形成的？",a:["木質部","韌皮部","形成層","表皮"],c:0,r:"木質部。"},
                {q:"氣孔的主要功能？",a:["氣體交換","吸收水分","光合作用","支撐"],c:0,r:"氣體交換。"},
                {q:"人體最大的消化腺？",a:["肝臟","胃","胰臟","小腸"],c:0,r:"肝臟。"},
                {q:"膽汁的功能？",a:["乳化脂質","分解蛋白質","分解澱粉","吸收水分"],c:0,r:"乳化脂質。"},
                {q:"蛋白質初步分解場所？",a:["胃","口","小腸","大腸"],c:0,r:"胃。"},
                {q:"氨轉化為尿素的場所？",a:["肝臟","腎臟","膀胱","血液"],c:0,r:"肝臟。"},
                {q:"尿液形成的場所？",a:["腎臟","輸尿管","膀胱","尿道"],c:0,r:"腎臟。"},
                {q:"淋巴結的功能？",a:["過濾病原體","製造紅血球","分泌激素","消化"],c:0,r:"防禦。"},
                {q:"肺泡周圍纏繞著什麼血管？",a:["微血管","動脈","靜脈","淋巴管"],c:0,r:"微血管。"},
                {q:"左心房接收來自哪裡的血液？",a:["肺靜脈","主動脈","肺動脈","大靜脈"],c:0,r:"肺靜脈。"},
                {q:"下列何者不含消化酵素？",a:["膽汁","唾液","胃液","胰液"],c:0,r:"膽汁。"},
                {q:"蒸散作用的主要動力？",a:["水分蒸發","根壓","毛細現象","光合作用"],c:0,r:"水分蒸發。"},
                {q:"根毛的功能？",a:["增加吸收面積","保護根尖","行光合作用","運輸"],c:0,r:"增加吸收面積。"},
                {q:"動脈壁的特徵？",a:["厚且彈性佳","薄","有瓣膜","通透性佳"],c:0,r:"厚且彈性佳。"},
                {q:"酵素的特性？",a:["專一性","通用性","消耗性","不可逆"],c:0,r:"專一性。"},
                {q:"血小板功能？",a:["凝血","運氧","防禦","運輸廢物"],c:0,r:"凝血。"},
                {q:"植物葉片下表皮通常？",a:["氣孔較多","氣孔較少","無氣孔","不一定"],c:0,r:"氣孔較多。"},
                {q:"胃蛋白酶的最適pH值？",a:["酸性","中性","鹼性","不一定"],c:0,r:"酸性。"},
                {q:"單子葉植物莖的維管束？",a:["散生","環狀","無維管束","年輪明顯"],c:0,r:"散生。"},
                {q:"人體心臟位於？",a:["胸腔偏左","胸腔偏右","腹腔","背部"],c:0,r:"胸腔偏左。"}
            ],
            chinese: [
                {q:"孔子被尊稱為？",a:["至聖先師","亞聖","詩仙","兵聖"],c:0,r:"至聖先師。"},
                {q:"「學而時習之」的「說」通？",a:["悅","曰","越","月"],c:0,r:"悅。"},
                {q:"「慍」意指？",a:["生氣","快樂","悲傷","害怕"],c:0,r:"生氣。"},
                {q:"朱自清擅長？",a:["散文","小說","戲劇","寓言"],c:0,r:"散文。"},
                {q:"《背影》父親買？",a:["橘子","蘋果","梨子","香蕉"],c:0,r:"橘子。"},
                {q:"「躊躇」意指？",a:["猶豫不決","果斷","快速","緩慢"],c:0,r:"猶豫不決。"},
                {q:"「蹣跚」形容？",a:["走路緩慢不穩","走路穩","跑得快","跳得高"],c:0,r:"走路緩慢不穩。"},
                {q:"杏林子創辦？",a:["伊甸基金會","慈濟","展望會","紅十字"],c:0,r:"伊甸基金會。"},
                {q:"《心囚》主旨？",a:["心靈自由","監獄可怕","健康重要","守法"],c:0,r:"心靈自由。"},
                {q:"分號用於？",a:["並列分句","疑問","感嘆","引文"],c:0,r:"並列分句。"},
                {q:"長頸鹿少睡是為了？",a:["生存","玩耍","覓食","聊天"],c:0,r:"生存。"},
                {q:"「頹唐」意指？",a:["衰老敗落","強壯","年輕","快樂"],c:0,r:"衰老敗落。"},
                {q:"「三人行必有我師」意在？",a:["隨時學習","找老師","結伴","競爭"],c:0,r:"隨時學習。"},
                {q:"朱自清背影中顏色？",a:["紫/紅","黑/白","藍/黃","綠/紅"],c:0,r:"紫毛大衣/朱紅橘子。"},
                {q:"杏林子病症？",a:["類風濕性關節炎","癌症","心臟病","小兒麻痺"],c:0,r:"類風濕性關節炎。"},
                {q:"冒號功能？",a:["總起下文","結束","轉折","疑問"],c:0,r:"總起下文。"},
                {q:"孔子是哪國人？",a:["魯","齊","楚","秦"],c:0,r:"魯國。"},
                {q:"「有朋自遠方來」？",a:["不亦樂乎","不亦君子","不亦說乎","不亦悲乎"],c:0,r:"不亦樂乎。"},
                {q:"朱自清父親體態？",a:["肥胖","瘦弱","高大","矮小"],c:0,r:"肥胖。"},
                {q:"心靈的枷鎖指？",a:["成見/慾望","法律","親情","友情"],c:0,r:"成見與慾望。"},
                {q:"貪睡長頸鹿啟示？",a:["自知之明","多睡","努力","誠實"],c:0,r:"自知之明。"},
                {q:"《論語》體裁？",a:["語錄體","詩歌","小說","散文"],c:0,r:"語錄體。"},
                {q:"「信」意指？",a:["誠信","相信","信件","信號"],c:0,r:"誠信。"},
                {q:"橘子象徵？",a:["父愛","母愛","友誼","離別"],c:0,r:"父愛。"},
                {q:"杏林子本名？",a:["劉俠","陳樹菊","張愛玲","三毛"],c:0,r:"劉俠。"},
                {q:"背影描寫重點？",a:["父親背影","車站風景","火車","路人"],c:0,r:"買橘子的背影。"},
                {q:"「名韁利鎖」比喻？",a:["受名利束縛","騎馬","鎖門","監獄"],c:0,r:"受名利束縛。"},
                {q:"孔子弟子稱？",a:["七十二賢","十八羅漢","三千世界","八仙"],c:0,r:"三千弟子七十二賢。"},
                {q:"朱自清年代？",a:["現代","古代","清朝","明朝"],c:0,r:"現代。"},
                {q:"心囚文體？",a:["議論散文","小說","詩歌","劇本"],c:0,r:"議論散文。"}
            ],
            english: [
                {q:"Stand up. 是？",a:["祈使句","疑問句","倒裝句","感嘆句"],c:0,r:"祈使句。"},
                {q:"Don't ___ (talk).",a:["talk","talking","talks","talked"],c:0,r:"talk。"},
                {q:"Please ___ (open).",a:["open","opens","opening","opened"],c:0,r:"open。"},
                {q:"What ___ you doing?",a:["are","is","am","do"],c:0,r:"are。"},
                {q:"She ___ (read) now.",a:["is reading","reads","read","reading"],c:0,r:"is reading。"},
                {q:"Look! The dog ___.",a:["is running","runs","run","running"],c:0,r:"is running。"},
                {q:"___ (sit) down.",a:["Sit","Sits","Sitting","Sat"],c:0,r:"Sit。"},
                {q:"First month?",a:["January","February","March","April"],c:0,r:"January。"},
                {q:"Second month?",a:["February","January","March","April"],c:0,r:"February。"},
                {q:"___ Christmas?",a:["When is","Where is","Who is","What is"],c:0,r:"When is..."},
                {q:"___ Sunday.",a:["on","in","at","of"],c:0,r:"on。"},
                {q:"___ July.",a:["in","on","at","to"],c:0,r:"in。"},
                {q:"Twelfth is?",a:["12th","12","20","2"],c:0,r:"12th。"},
                {q:"Plural of box?",a:["boxes","boxs","boxies","box"],c:0,r:"boxes。"},
                {q:"Plural of baby?",a:["babies","babys","babyes","baby"],c:0,r:"babies。"},
                {q:"Plural of man?",a:["men","mans","manes","man"],c:0,r:"men。"},
                {q:"___ he like?",a:["Does","Do","Is","Are"],c:0,r:"Does。"},
                {q:"They ___ not.",a:["do","does","is","are"],c:0,r:"do。"},
                {q:"V-ing of run?",a:["running","runing","run","runs"],c:0,r:"running。"},
                {q:"V-ing of dance?",a:["dancing","danceing","dances","dance"],c:0,r:"dancing。"},
                {q:"Let's ___ (go).",a:["go","going","goes","went"],c:0,r:"go。"},
                {q:"Listen! Birds ___.",a:["are singing","sings","sing","singing"],c:0,r:"are singing。"},
                {q:"Plural of wife?",a:["wives","wifes","wivs","wife"],c:0,r:"wives。"},
                {q:"Plural of foot?",a:["feet","foots","feets","foot"],c:0,r:"feet。"},
                {q:"___ (be) quiet.",a:["Be","Do","Are","Is"],c:0,r:"Be。"},
                {q:"Third is?",a:["3rd","3","3th","three"],c:0,r:"3rd。"},
                {q:"__ May 5th.",a:["on","in","at","of"],c:0,r:"on。"},
                {q:"He ___ (write).",a:["is writing","write","writing","writ"],c:0,r:"is writing。"},
                {q:"Plural of bus?",a:["buses","buss","busies","bus"],c:0,r:"buses。"},
                {q:"Don't ___ (sleep).",a:["sleep","sleeping","sleeps","slept"],c:0,r:"sleep。"}
            ],
            history: [
                {q:"舊石器文化？",a:["長濱","大坌坑","圓山","十三行"],c:0,r:"長濱。"},
                {q:"新石器特徵？",a:["農業/陶器","用火","煉鐵","文字"],c:0,r:"農業。"},
                {q:"十三行文化？",a:["金屬器","舊石器","新石器","現代"],c:0,r:"金屬器。"},
                {q:"荷蘭據點？",a:["熱蘭遮城","聖薩爾瓦多城","紅毛城","台北城"],c:0,r:"熱蘭遮城。"},
                {q:"西班牙據點？",a:["北部","南部","東部","中部"],c:0,r:"北部。"},
                {q:"郭懷一反抗？",a:["荷蘭","西班牙","鄭成功","清朝"],c:0,r:"荷蘭。"},
                {q:"荷蘭輸出？",a:["蔗糖/鹿皮","茶葉","樟腦","鴉片"],c:0,r:"蔗糖/鹿皮。"},
                {q:"聖薩爾瓦多城？",a:["基隆","淡水","台南","高雄"],c:0,r:"基隆。"},
                {q:"荷蘭引進？",a:["黃牛","水牛","馬","羊"],c:0,r:"黃牛。"},
                {q:"普羅民遮城？",a:["赤崁樓","安平古堡","紅毛城","億載金城"],c:0,r:"赤崁樓。"},
                {q:"西班牙被誰趕？",a:["荷蘭","鄭成功","原住民","日本人"],c:0,r:"荷蘭。"},
                {q:"王田？",a:["荷蘭官方地","原住民地","鄭氏地","漢人地"],c:0,r:"荷蘭所有。"},
                {q:"大坌坑特徵？",a:["繩紋陶","彩陶","黑陶","幾何印紋"],c:0,r:"繩紋陶。"},
                {q:"圓山發現？",a:["貝塚","石板棺","煉鐵爐","玉器"],c:0,r:"貝塚。"},
                {q:"西班牙傳教？",a:["天主教","基督教","佛教","伊斯蘭教"],c:0,r:"天主教。"},
                {q:"荷蘭文字？",a:["新港文","漢字","英文","日文"],c:0,r:"新港文。"},
                {q:"贌社制度？",a:["承包交易","公行","自由貿易","以物易物"],c:0,r:"承包交易。"},
                {q:"母系社會？",a:["阿美","排灣","布農","鄒族"],c:0,r:"阿美。"},
                {q:"卑南文化？",a:["石板棺","貝塚","鐵渣","幾何陶"],c:0,r:"石板棺。"},
                {q:"荷蘭統治？",a:["地方會議","武力鎮壓","放任","同化"],c:0,r:"地方會議。"},
                {q:"舊石器時代特徵？",a:["打製石器","磨製石器","煉鐵","燒陶"],c:0,r:"打製石器。"},
                {q:"十三行遺址位置？",a:["八里","淡水","基隆","台南"],c:0,r:"八里。"},
                {q:"大坌坑屬於新石器？",a:["早期","中期","晚期","末期"],c:0,r:"早期。"},
                {q:"荷蘭人主要貿易品？",a:["香料","絲綢","白銀","以上皆是"],c:3,r:"以上皆是。"},
                {q:"聖多明哥城位於？",a:["淡水","基隆","台南","高雄"],c:0,r:"淡水。"},
                {q:"已知用火的文化？",a:["長濱","圓山","卑南","十三行"],c:0,r:"長濱。"},
                {q:"平埔族多為？",a:["母系","父系","雙系","不一定"],c:0,r:"母系(如西拉雅)。"},
                {q:"高山族多為？",a:["父系","母系","雙系","不一定"],c:0,r:"父系(如泰雅/布農)。"},
                {q:"台灣信史開始？",a:["荷西時期","鄭氏","清朝","日治"],c:0,r:"荷西時期。"},
                {q:"歐洲人來台目的？",a:["貿易傳教","觀光","探險","移民"],c:0,r:"貿易與傳教。"}
            ],
            geography: [
                {q:"面積最大地形？",a:["山地","平原","丘陵","台地"],c:0,r:"山地。"},
                {q:"北回歸線經過？",a:["嘉義","台北","台中","屏東"],c:0,r:"嘉義。"},
                {q:"板塊交界？",a:["歐亞/菲律賓海","歐亞/太平洋","太平洋/菲律賓海","歐亞/印度洋"],c:0,r:"歐亞/菲律賓海。"},
                {q:"中央山脈？",a:["分水嶺","阻擋颱風","火山","最高"],c:0,r:"分水嶺。"},
                {q:"最長河川？",a:["濁水溪","高屏溪","淡水河","曾文溪"],c:0,r:"濁水溪。"},
                {q:"流域最大？",a:["高屏溪","淡水河","濁水溪","大甲溪"],c:0,r:"高屏溪。"},
                {q:"流量最穩？",a:["淡水河","濁水溪","高屏溪","秀姑巒溪"],c:0,r:"淡水河。"},
                {q:"河川特色？",a:["坡陡流急","長而平緩","含沙少","流量穩"],c:0,r:"坡陡流急。"},
                {q:"北部海岸？",a:["岬灣","沙岸","珊瑚礁","斷層"],c:0,r:"岬灣。"},
                {q:"西部海岸？",a:["沙岸","水深","岩石","斷層"],c:0,r:"沙岸。"},
                {q:"東部海岸？",a:["斷層","曲折","寬廣","珊瑚礁"],c:0,r:"斷層。"},
                {q:"南部海岸？",a:["珊瑚礁","沙岸","岩岸","斷層"],c:0,r:"珊瑚礁。"},
                {q:"夏季季風？",a:["西南","東北","西北","東南"],c:0,r:"西南。"},
                {q:"冬季季風？",a:["東北","西南","西北","東南"],c:0,r:"東北。"},
                {q:"梅雨季節？",a:["5-6月","3-4月","7-8月","9-10月"],c:0,r:"5-6月。"},
                {q:"冬季台北多雨？",a:["東北季風","地形雨","對流雨","颱風"],c:0,r:"東北季風。"},
                {q:"嘉南平原？",a:["河流沖積","火山","風力","板塊"],c:0,r:"河流沖積。"},
                {q:"台北盆地？",a:["斷層陷落","隕石","火山","侵蝕"],c:0,r:"斷層陷落。"},
                {q:"最高山？",a:["玉山","雪山","中央","阿里"],c:0,r:"玉山。"},{q:"養殖漁業？",a:["西部","東部","北部","南部"],c:0,r:"西部。"},
                {q:"台地特徵？",a:["頂部平坦","地勢低窪","起伏大","靠海"],c:0,r:"頂部平坦。"},
                {q:"盆地特徵？",a:["四周高","四周低","平坦","靠海"],c:0,r:"四周高中間低。"},
                {q:"荒溪型河川？",a:["流量變化大","流量穩","長","乾淨"],c:0,r:"流量變化大。"},
                {q:"寒害季節？",a:["冬季","夏季","春季","秋季"],c:0,r:"冬季。"},
                {q:"颱風季節？",a:["夏秋","冬","春","全"],c:0,r:"夏秋。"},
                {q:"沙洲潟湖？",a:["西部","東部","北部","南部"],c:0,r:"西部。"},
                {q:"水庫功能？",a:["調節水資源","發電","觀光","以上皆是"],c:3,r:"以上皆是。"},
                {q:"珊瑚礁條件？",a:["熱帶淺海","寒帶深海","河口","湖泊"],c:0,r:"熱帶淺海。"},
                {q:"岬灣成因？",a:["岩層軟硬","河流","風力","火山"],c:0,r:"岩層軟硬差異侵蝕。"},
                {q:"斷層海岸？",a:["花東","雲嘉","桃竹","恆春"],c:0,r:"花東。"}
            ],
            civics: [
                {q:"配偶屬於？",a:["配偶","血親","姻親","法定血親"],c:0,r:"配偶。"},
                {q:"岳父屬於？",a:["姻親","血親","配偶","法定血親"],c:0,r:"姻親。"},
                {q:"收養關係？",a:["法定血親","自然血親","姻親","配偶"],c:0,r:"法定血親。"},
                {q:"兄弟姊妹？",a:["二親等","一","三","四"],c:0,r:"二親等。"},
                {q:"父母？",a:["一親等","二","三","無"],c:0,r:"一親等。"},
                {q:"夫妻+未婚子女？",a:["小家庭","折衷","大家庭","單親"],c:0,r:"小家庭。"},
                {q:"三代同堂？",a:["折衷","小家庭","大家庭","頂客"],c:0,r:"折衷家庭。"},
                {q:"家暴法保障？",a:["家庭成員","配偶","兒童","老人"],c:0,r:"家庭成員。"},
                {q:"家暴申請？",a:["保護令","搜索票","拘票","罰單"],c:0,r:"保護令。"},
                {q:"性別平權？",a:["家務分工","男主外","從父姓","財產傳子"],c:0,r:"家務分工。"},
                {q:"子女姓氏？",a:["父母約定","父姓","母姓","抽籤"],c:0,r:"父母約定。"},
                {q:"旁系禁婚？",a:["六親等","三親等","五親等","無"],c:0,r:"六親等。"},
                {q:"頂客族？",a:["雙薪無子","單親","三代","隔代"],c:0,r:"雙薪無子。"},
                {q:"提供物資？",a:["經濟","生育","教育","情感"],c:0,r:"經濟功能。"},
                {q:"強制力規範？",a:["法律","道德","風俗","宗教"],c:0,r:"法律。"},
                {q:"讓座？",a:["道德","法律","宗教","流行"],c:0,r:"道德。"},
                {q:"發紅包？",a:["風俗","法律","宗教","道德"],c:0,r:"風俗。"},
                {q:"管委會？",a:["地緣","血緣","業緣","趣緣"],c:0,r:"地緣。"},
                {q:"工會？",a:["業緣","血緣","地緣","趣緣"],c:0,r:"業緣。"},
                {q:"登山社？",a:["趣緣","血緣","地緣","業緣"],c:0,r:"趣緣。"},
                {q:"宗親會？",a:["血緣","地緣","業緣","趣緣"],c:0,r:"血緣。"},
                {q:"法律制定？",a:["立法院","行政院","司法院","總統"],c:0,r:"立法院。"},
                {q:"法律處罰？",a:["最嚴厲","最輕","無","隨意"],c:0,r:"最嚴厲(刑罰)。"},
                {q:"姻親包含？",a:["以上皆是","血親的配偶","配偶的血親","配偶血親的配偶"],c:0,r:"以上皆是。"},
                {q:"家庭功能無？",a:["戰爭","生育","經濟","保護"],c:0,r:"戰爭。"},
                {q:"單親家庭？",a:["父或母一方","祖父母","無子女","三代"],c:0,r:"父或母一方。"},
                {q:"隔代教養？",a:["祖父母照顧","父母照顧","保母照顧","學校照顧"],c:0,r:"祖父母照顧。"},
                {q:"繼承權？",a:["男女平等","男先","女先","長子先"],c:0,r:"男女平等。"},
                {q:"宗教約束？",a:["超自然/教規","法律","輿論","良心"],c:0,r:"超自然/教規。"},
                {q:"志願結社？",a:["自由/公益","強制","營利","官方"],c:0,r:"自由/公益。"}
            ]
        };

        // --- GLOBAL LOGIC ---
        let currentSubject = 'city';
        let quizState = { active: false, questions: [], index: 0, score: 0, hp: 3 };

        document.addEventListener('DOMContentLoaded', () => {
            loadGame();
            renderSidebar();
            updateResourceUI();
            switchView('city');
        });

        function loadGame() { const saved = localStorage.getItem('rimuru_save_v14'); if(saved) Object.assign(gameState, JSON.parse(saved)); }
        function saveGame() { localStorage.setItem('rimuru_save_v14', JSON.stringify(gameState)); updateResourceUI(); }
        function updateResourceUI() {
            document.getElementById('res-magic').innerText = gameState.magicules;
            document.getElementById('res-herb').innerText = gameState.herbs;
            let lvl = 1;
            if(gameState.buildings.castle) lvl = 5; else if(gameState.buildings.arena) lvl = 4; else if(gameState.buildings.school) lvl = 3; else if(gameState.buildings.blacksmith) lvl = 2;
            document.getElementById('res-level').innerText = `Lv.${lvl}`;
        }

        function shareApp() {
            const text = "這是我的「坦派斯特期中考特訓班」APP！包含全科筆記與遊戲化測驗，快來下載 HTML 一起複習！";
            if (navigator.share) {
                navigator.share({ title: '坦派斯特特訓班', text: text }).catch(console.error);
            } else {
                navigator.clipboard.writeText(text).then(() => alert("已複製分享連結！"));
            }
        }

        function renderSidebar() {
            document.getElementById('sidebar-subjects').innerHTML = Object.values(studyData).map(s => `<button onclick="switchView('${s.id}')" id="nav-${s.id}" class="nav-item w-full text-left p-3 rounded-xl flex items-center gap-3 text-slate-500 hover:bg-sky-50 transition-all"><div class="w-6 text-center"><i class="fa-solid fa-${s.icon}"></i></div>${s.title.split(' ')[0]}</button>`).join('');
        }

        function switchView(viewId) {
            currentSubject = viewId;
            document.querySelectorAll('.nav-item').forEach(el => el.className = `nav-item w-full text-left p-3 rounded-xl flex items-center gap-3 text-slate-500 hover:bg-sky-50 transition-all`);
            const btn = document.getElementById(`nav-${viewId}`);
            if(btn) btn.className = `nav-item w-full text-left p-3 rounded-xl flex items-center gap-3 bg-sky-100 text-sky-700 font-bold shadow-sm transition-all`;
            const container = document.getElementById('main-container');
            if(viewId === 'city') renderCity(container); else renderSubject(viewId, container);
        }

        function renderCity(container) {
            container.innerHTML = `
                <div class="max-w-5xl mx-auto space-y-8 animate-fade-in">
                    <div class="glass-panel p-8 rounded-3xl relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10 text-9xl text-sky-900 rotate-12"><i class="fa-solid fa-crown"></i></div>
                        <h2 class="text-3xl font-black text-slate-800 mb-2">坦派斯特建設日誌</h2>
                        <p class="text-slate-600">透過學習獲得魔素，建設你的魔物聯邦！</p>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${Object.entries(buildingsInfo).map(([key, info]) => {
                            const built = gameState.buildings[key];
                            return `<div class="bg-white p-6 rounded-2xl border-2 ${built ? 'border-sky-400 shadow-md' : 'border-slate-100 opacity-70'} flex flex-col items-center text-center transition hover:scale-105"><div class="w-16 h-16 rounded-full ${built ? 'bg-sky-100 text-sky-600' : 'bg-slate-100 text-slate-300'} flex items-center justify-center text-3xl mb-4"><i class="fa-solid fa-${info.icon}"></i></div><h3 class="font-bold text-lg text-slate-800">${info.name}</h3><p class="text-sm text-slate-500 mb-4">${info.desc}</p>${built ? `<span class="bg-green-100 text-green-700 px-3 py-1 rounded-full text-xs font-bold"><i class="fa-solid fa-check"></i> 已建設</span>` : `<button onclick="build('${key}', ${info.cost})" class="bg-sky-600 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-sky-500 ${gameState.magicules < info.cost ? 'opacity-50 cursor-not-allowed' : ''}">建設 (${info.cost} <i class="fa-solid fa-bolt text-yellow-300"></i>)</button>`}</div>`
                        }).join('')}
                    </div>
                </div>`;
        }

        function build(key, cost) {
            if(gameState.magicules >= cost) { gameState.magicules -= cost; gameState.buildings[key] = true; saveGame(); renderCity(document.getElementById('main-container')); alert(`建設成功！${buildingsInfo[key].name} 加入了你的城邦！`); } else { alert("魔素不足！快去刷題賺取魔素吧！"); }
        }

        function renderSubject(id, container) {
            const data = studyData[id];
            const notes = notesData[id] || [];
            container.innerHTML = `
                <div class="max-w-6xl mx-auto space-y-8 animate-fade-in">
                    <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                        <div><h2 class="text-3xl font-black text-slate-800 flex items-center gap-3"><span class="text-${data.color}-500"><i class="fa-solid fa-${data.icon}"></i></span>${data.title}</h2><p class="text-slate-500 mt-1">${data.summary}</p></div>
                        <button onclick="startQuiz('${id}')" class="bg-gradient-to-r from-${data.color}-500 to-${data.color}-600 text-white px-8 py-3 rounded-2xl font-bold shadow-lg shadow-${data.color}-200 transition hover:scale-105 flex items-center gap-2"><i class="fa-solid fa-khanda"></i> 討伐此單元</button>
                    </div>
                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div class="lg:col-span-2 space-y-6">${notes.map(n => `<div class="note-card bg-white rounded-2xl p-6 border border-slate-100 shadow-sm"><h3 class="font-bold text-lg text-${data.color}-700 mb-3 flex items-center gap-2"><i class="fa-solid fa-scroll"></i> ${n.title}</h3><ul class="space-y-3">${n.details.map(d => `<li class="text-slate-600 text-sm pl-4 border-l-2 border-${data.color}-200 leading-relaxed">${d}</li>`).join('')}</ul></div>`).join('')}</div>
                        <div class="space-y-6"><div class="bg-white rounded-3xl shadow-xl border-4 border-slate-100 overflow-hidden min-h-[400px] flex flex-col"><div class="bg-slate-50 px-4 py-3 border-b border-slate-100 flex justify-between items-center"><span class="font-bold text-slate-700 text-sm"><i class="fa-solid fa-gamepad mr-2"></i>互動修煉場</span></div><div class="flex-1 relative bg-slate-50/50 p-4" id="tool-container">${getInteractiveTool(id)}</div></div></div>
                    </div>
                </div>`;
            setTimeout(() => {
                if(id === 'math') initSlimeClicker();
                if(id === 'biology') initBioDragDrop();
                if(id === 'geography') initGeoMap();
                if(window.MathJax) MathJax.typesetPromise();
            }, 100);
        }

        function getInteractiveTool(id) {
            if(id === 'math') return `<div class="text-center h-full flex flex-col items-center justify-center"><div class="text-sm text-slate-500 mb-4">點擊史萊姆進行指數分裂 ($$2^n$$)</div><div id="slime-container" class="relative w-full h-64 cursor-pointer" onclick="splitSlime()"><div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 transition-all duration-200" id="main-slime"><div class="w-24 h-24 bg-sky-400 rounded-full flex items-center justify-center text-white font-black text-2xl shadow-lg shadow-sky-300 animate-bounce select-none">1</div></div></div><div class="mt-4 text-xl font-bold text-indigo-600">數量: <span id="slime-count">1</span> ($$2^0$$)</div><button onclick="resetSlime()" class="mt-4 text-xs text-slate-400 hover:text-red-500">Reset</button></div>`;
            if(id === 'biology') return `<div class="h-full flex flex-col"><div class="text-xs text-slate-500 mb-2">拖曳器官排列正確消化順序：</div><div id="bio-drop-zone" class="flex-1 border-2 border-dashed border-emerald-200 rounded-xl bg-emerald-50/50 p-4 flex flex-col gap-2 items-center justify-center drop-zone text-sm text-emerald-400 mb-4"><i class="fa-solid fa-arrow-down mb-1"></i> 請按順序拖入此處</div><div id="bio-source" class="flex flex-wrap gap-2 justify-center">${['胃','大腸','食道','小腸','口','肛門'].sort(()=>Math.random()-0.5).map(item => `<div class="draggable-item bg-white px-3 py-1 rounded-full shadow border border-slate-200 text-sm font-bold text-slate-600" draggable="true">${item}</div>`).join('')}</div><button onclick="checkBioOrder()" class="mt-4 w-full bg-emerald-500 text-white rounded-lg py-2 font-bold text-sm">檢查順序</button><div id="bio-result" class="text-center text-xs mt-2 h-4 font-bold"></div></div>`;
            if(id === 'geography') return `<div class="h-full flex flex-col items-center"><div class="text-xs text-slate-500 mb-2">拖曳標籤至正確區域 (北/中/南/東)：</div><div class="relative w-48 h-64 bg-slate-200 rounded-3xl my-2 flex flex-col border-4 border-white shadow-inner overflow-hidden"><div id="geo-n" class="flex-1 bg-blue-100/50 border-b border-white flex items-center justify-center text-xs text-slate-400 drop-zone" data-zone="n">北</div><div class="flex-1 flex"><div id="geo-w" class="w-2/3 bg-green-100/50 border-r border-white flex items-center justify-center text-xs text-slate-400 drop-zone" data-zone="w">西</div><div id="geo-e" class="w-1/3 bg-yellow-100/50 flex items-center justify-center text-xs text-slate-400 drop-zone" data-zone="e">東</div></div><div id="geo-s" class="flex-1 bg-red-100/50 border-t border-white flex items-center justify-center text-xs text-slate-400 drop-zone" data-zone="s">南</div></div><div id="geo-tags" class="flex flex-wrap gap-2 justify-center mt-2"><div class="draggable-item bg-white px-2 py-1 text-xs border rounded shadow" draggable="true" data-ans="n">盆地/岬灣</div><div class="draggable-item bg-white px-2 py-1 text-xs border rounded shadow" draggable="true" data-ans="w">沙岸/平原</div><div class="draggable-item bg-white px-2 py-1 text-xs border rounded shadow" draggable="true" data-ans="e">斷層/陡峭</div><div class="draggable-item bg-white px-2 py-1 text-xs border rounded shadow" draggable="true" data-ans="s">珊瑚礁/熱帶</div></div><div id="geo-result" class="text-center text-xs mt-2 h-4 font-bold text-sky-600"></div></div>`;
            if(id === 'civics') return `<div class="h-full flex flex-col items-center justify-center"><div class="text-sm text-slate-500 mb-4 font-bold">親戚稱謂計算機</div><div class="bg-white p-4 rounded-xl border border-rose-100 shadow-sm w-64"><div id="kin-result" class="text-center text-2xl font-bold text-rose-600 mb-4 h-8">?</div><div class="grid grid-cols-2 gap-2"><button class="kinship-btn" onclick="calcKin('爸爸的哥哥')">爸爸的哥哥</button><button class="kinship-btn" onclick="calcKin('媽媽的兄弟')">媽媽的兄弟</button><button class="kinship-btn" onclick="calcKin('姊妹的丈夫')">姊妹的丈夫</button><button class="kinship-btn" onclick="calcKin('哥哥的妻子')">哥哥的妻子</button></div></div></div>`;
            if(id === 'english') return `<div class="h-full flex flex-col items-center justify-center"><div class="text-sm text-slate-500 mb-4 font-bold">單字翻翻樂</div><div class="bg-white w-48 h-32 rounded-xl shadow-lg border border-blue-100 flex items-center justify-center cursor-pointer flip-card" onclick="flipWord(this)"><div class="text-2xl font-bold text-blue-600" id="word-card">Christmas</div></div><button class="mt-4 text-xs text-slate-400" onclick="nextWord()">下一個 (Next)</button></div>`;
            return `<div class="h-full flex items-center justify-center text-slate-400 text-sm">此學科暫無互動工具，請進行測驗。</div>`;
        }

        // --- INTERACTIVE LOGIC ---
        let slimeStep = 0;
        function initSlimeClicker() {
            slimeStep = 0;
            const c = document.getElementById('slime-container');
            if(c) {
                c.innerHTML = `<div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 transition-all duration-200" id="main-slime"><div class="w-24 h-24 bg-sky-400 rounded-full flex items-center justify-center text-white font-black text-2xl shadow-lg shadow-sky-300 animate-bounce select-none">1</div></div>`;
                document.getElementById('slime-count').innerHTML = `1 ($$2^0$$)`;
                if(window.MathJax) MathJax.typesetPromise();
            }
        }
        function splitSlime() {
            if(slimeStep >= 6) return;
            slimeStep++;
            const count = Math.pow(2, slimeStep);
            document.getElementById('slime-count').innerHTML = `${count} ($$2^${slimeStep}$$)`;
            const c = document.getElementById('slime-container');
            c.innerHTML = '';
            for(let i=0; i<count; i++) {
                const s = document.createElement('div');
                s.className = "absolute w-8 h-8 bg-sky-400 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-sm transition-all duration-500 animate-bounce";
                s.innerText = "1";
                s.style.top = `${Math.random()*80 + 10}%`; s.style.left = `${Math.random()*80 + 10}%`;
                c.appendChild(s);
            }
            if(window.MathJax) MathJax.typesetPromise();
        }
        function resetSlime() { initSlimeClicker(); }

        function initBioDragDrop() {
            const draggables = document.querySelectorAll('#bio-source .draggable-item');
            const dropZone = document.getElementById('bio-drop-zone');
            if(!dropZone) return;
            draggables.forEach(d => { d.addEventListener('dragstart', e => { e.dataTransfer.setData('text/plain', e.target.innerText); e.target.classList.add('opacity-50'); }); d.addEventListener('dragend', e => { e.target.classList.remove('opacity-50'); }); });
            dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('drag-over'); });
            dropZone.addEventListener('dragleave', e => { dropZone.classList.remove('drag-over'); });
            dropZone.addEventListener('drop', e => {
                e.preventDefault(); dropZone.classList.remove('drag-over');
                const data = e.dataTransfer.getData('text/plain');
                if(data && dropZone.children.length < 7) { const el = document.createElement('div'); el.className = "bg-white px-3 py-1 rounded shadow text-sm font-bold text-emerald-600 w-full text-center"; el.innerText = data; dropZone.appendChild(el); }
            });
        }
        function checkBioOrder() {
            const correct = ['口','食道','胃','小腸','大腸','肛門'];
            const user = Array.from(document.getElementById('bio-drop-zone').children).filter(el => el.tagName === 'DIV').map(el => el.innerText);
            const res = document.getElementById('bio-result');
            if(JSON.stringify(user) === JSON.stringify(correct)) { res.innerText = "正確！完美消化！(+10 魔素)"; res.className = "text-center text-xs mt-2 h-4 font-bold text-green-500"; gameState.magicules += 10; updateResourceUI(); } else { res.innerText = "順序錯誤，再試試看！"; res.className = "text-center text-xs mt-2 h-4 font-bold text-red-500"; }
        }

        function initGeoMap() {
            const tags = document.querySelectorAll('#geo-tags .draggable-item');
            const zones = document.querySelectorAll('.drop-zone');
            tags.forEach(t => { t.addEventListener('dragstart', e => { e.dataTransfer.setData('ans', e.target.dataset.ans); e.target.classList.add('opacity-50'); }); t.addEventListener('dragend', e => e.target.classList.remove('opacity-50')); });
            zones.forEach(z => { z.addEventListener('dragover', e => e.preventDefault()); z.addEventListener('drop', e => { e.preventDefault(); const ans = e.dataTransfer.getData('ans'); const targetZone = z.dataset.zone; const res = document.getElementById('geo-result'); if(ans === targetZone) { z.style.backgroundColor = '#bbf7d0'; z.innerText = "O"; res.innerText = "配置正確！(+5 魔素)"; gameState.magicules += 5; updateResourceUI(); } else { res.innerText = "位置不對喔..."; } }); });
        }

        // New Games
        function calcKin(rel) {
            const map = { '爸爸的哥哥': '伯父', '媽媽的兄弟': '舅舅', '姊妹的丈夫': '姊夫/妹夫', '哥哥的妻子': '嫂嫂' };
            document.getElementById('kin-result').innerText = map[rel];
        }
        
        const engWords = [
            {w:"Christmas", m:"聖誕節"}, {w:"Celebrate", m:"慶祝"}, {w:"Twelfth", m:"第12"}, {w:"Clap", m:"拍手"},
            {w:"Touch", m:"碰觸"}, {w:"Shoulder", m:"肩膀"}, {w:"Heavy", m:"重的"}, {w:"Wave", m:"揮手"}
        ];
        function flipWord(el) {
            const current = document.getElementById('word-card').innerText;
            const item = engWords.find(i => i.w === current || i.m === current);
            if(item) document.getElementById('word-card').innerText = (current === item.w) ? item.m : item.w;
        }
        function nextWord() {
            const r = engWords[Math.floor(Math.random() * engWords.length)];
            document.getElementById('word-card').innerText = r.w;
        }

        // --- QUIZ SYSTEM ---
        function openQuizSelector() {
            document.getElementById('quiz-modal').classList.remove('hidden');
            document.getElementById('quiz-selector').innerHTML = Object.values(studyData).map(s => `<button onclick="startQuiz('${s.id}')" class="flex flex-col items-center justify-center p-4 bg-white border-2 border-slate-100 rounded-2xl hover:border-${s.color}-400 hover:bg-${s.color}-50 transition group"><i class="fa-solid fa-${s.icon} text-3xl text-${s.color}-400 mb-2 group-hover:scale-110 transition"></i><span class="font-bold text-slate-600 text-sm">${s.title.split(' ')[0]}</span></button>`).join('');
            document.getElementById('quiz-selector').classList.remove('hidden');
            document.getElementById('quiz-question-view').classList.add('hidden');
            document.getElementById('quiz-results-view').classList.add('hidden');
            document.getElementById('quiz-footer').classList.add('hidden');
        }
        function closeQuizModal() { document.getElementById('quiz-modal').classList.add('hidden'); }
        
        // Randomize Options
        function startQuiz(id) {
            quizState.active = true; quizState.score = 0; quizState.hp = 3; quizState.index = 0;
            const allQ = qDB[id] || [];
            quizState.questions = [...allQ].sort(() => 0.5 - Math.random()).slice(0, 10);
            
            // Randomize options for each selected question
            quizState.questions.forEach(q => {
                const options = q.a.map((opt, i) => ({ text: opt, isCorrect: i === q.c }));
                options.sort(() => 0.5 - Math.random());
                q.shuffledOptions = options;
            });

            document.getElementById('quiz-hp').innerText = quizState.hp;
            document.getElementById('quiz-selector').classList.add('hidden');
            document.getElementById('quiz-question-view').classList.remove('hidden');
            document.getElementById('quiz-footer').classList.remove('hidden');
            renderQuizQuestion();
        }

        function renderQuizQuestion() {
            const q = quizState.questions[quizState.index];
            if(!q) { endQuiz(); return; }
            const pct = (quizState.index / quizState.questions.length) * 100;
            document.getElementById('quiz-progress-bar').style.width = `${pct}%`;
            
            document.getElementById('question-card').innerHTML = `
                <h4 class="text-xl font-bold text-slate-800 mb-6 leading-relaxed">${q.q}</h4>
                <div class="grid gap-3">
                    ${q.shuffledOptions.map((opt, i) => `
                        <button onclick="answer(${i})" id="opt-${i}" class="w-full text-left p-4 rounded-xl border-2 border-slate-100 hover:border-sky-400 hover:bg-sky-50 font-bold text-slate-600 transition relative overflow-hidden group">
                            <span class="z-10 relative flex items-center">
                                <span class="w-6 h-6 rounded-full bg-slate-200 text-slate-500 text-xs flex items-center justify-center mr-3">${String.fromCharCode(65+i)}</span>
                                ${opt.text}
                            </span>
                        </button>
                    `).join('')}
                </div>
                <div id="quiz-feedback" class="hidden mt-4 bg-slate-50 p-4 rounded-xl text-sm border border-slate-200">
                    <div class="font-bold mb-1" id="fb-title"></div>
                    <div class="text-slate-600">${q.r}</div>
                </div>
            `;
            document.getElementById('btn-next').disabled = true; document.getElementById('btn-next').classList.add('opacity-50', 'cursor-not-allowed'); document.getElementById('btn-use-herb').classList.remove('hidden');
            if(window.MathJax) MathJax.typesetPromise();
        }

        function answer(selectedIndex) {
            const q = quizState.questions[quizState.index];
            const isCorrect = q.shuffledOptions[selectedIndex].isCorrect;
            
            // Find correct index in shuffled array
            const correctIndex = q.shuffledOptions.findIndex(o => o.isCorrect);

            // Disable buttons
            q.shuffledOptions.forEach((_, i) => document.getElementById(`opt-${i}`).disabled = true);
            
            document.getElementById('quiz-feedback').classList.remove('hidden');
            
            if(isCorrect) {
                quizState.score++;
                document.getElementById(`opt-${selectedIndex}`).classList.add('bg-green-100', 'border-green-500', 'text-green-800');
                document.getElementById('fb-title').innerHTML = `<span class="text-green-600"><i class="fa-solid fa-check"></i> 正確！</span>`;
            } else {
                quizState.hp--;
                document.getElementById('quiz-hp').innerText = quizState.hp;
                document.getElementById(`opt-${selectedIndex}`).classList.add('bg-red-100', 'border-red-500', 'text-red-800');
                document.getElementById(`opt-${correctIndex}`).classList.add('bg-green-100', 'border-green-500');
                document.getElementById('fb-title').innerHTML = `<span class="text-red-500"><i class="fa-solid fa-xmark"></i> 錯誤！</span>`;
            }
            
            document.getElementById('btn-next').disabled = false;
            document.getElementById('btn-next').classList.remove('opacity-50', 'cursor-not-allowed');
            document.getElementById('btn-use-herb').classList.add('hidden');
            
            if(quizState.hp <= 0) setTimeout(endQuiz, 1500);
            if(window.MathJax) MathJax.typesetPromise();
        }

        function useHerb() {
            if(gameState.herbs > 0) {
                gameState.herbs--; updateResourceUI();
                const q = quizState.questions[quizState.index];
                const correctIndex = q.shuffledOptions.findIndex(o => o.isCorrect);
                document.getElementById(`opt-${correctIndex}`).classList.add('ring-2', 'ring-green-400');
            } else { alert("草藥不足！"); }
        }

        function nextQuestion() { quizState.index++; if(quizState.index >= quizState.questions.length) endQuiz(); else renderQuizQuestion(); }
        
        function endQuiz() {
            document.getElementById('quiz-question-view').classList.add('hidden'); document.getElementById('quiz-footer').classList.add('hidden'); document.getElementById('quiz-results-view').classList.remove('hidden');
            const isWin = quizState.hp > 0;
            const magicEarned = isWin ? quizState.score * 10 : Math.floor(quizState.score * 2);
            const herbsEarned = isWin ? Math.floor(quizState.score / 3) : 0;
            gameState.magicules += magicEarned; gameState.herbs += herbsEarned; saveGame();
            document.getElementById('result-msg').innerText = isWin ? "討伐大成功！獲得了戰利品。" : "討伐失敗...請重整旗鼓再來。";
            document.getElementById('reward-magic').innerText = `+${magicEarned}`; document.getElementById('reward-herb').innerText = `+${herbsEarned}`;
            // IMPORTANT: Using generic placeholder image for the popup. User can replace the src.
            document.getElementById('result-icon-container').innerHTML = isWin ? 
                `<div class="victory-img-container"><img src="rimuru_victory.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/4712/4712009.png'" class="w-40 h-40 object-contain mx-auto" alt="Victory"></div>` : 
                `<div class="text-6xl text-slate-300"><i class="fa-solid fa-skull"></i></div>`;
        }
    </script>
</body>
</html>
